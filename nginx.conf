server {
  listen 80;
  server_name localhost;

  root /usr/share/nginx/html;
  index index.html;

  # debugging de errores intermitentes
  error_log /var/log/nginx/error.log debug;
  access_log /var/log/nginx/access.log combined;

  # Timeouts para evitar 502
  send_timeout 60s;
  client_body_timeout 60s;
  client_header_timeout 60s;

  # Buffer sizes para manejar assets grandes
  client_body_buffer_size 128k;
  client_max_body_size 10m;
  # Assets estáticos con hash (Vite genera: /assets/nombre-[hash].ext)
  location /assets/ {
    # archivo directamente
    try_files $uri =404;

    # Cache moderado para assets con hash
    # Se reduce de max (31536000s)
    expires 7d;
    add_header Cache-Control "public, max-age=604800, stale-while-revalidate=86400";
    add_header X-Content-Type-Options "nosniff";

    # CORS headers si es necesario
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, OPTIONS";

    # Tipos MIME explícitos
    types {
      text/css css;
      application/javascript js mjs;
      image/svg+xml svg svgz;
      font/woff woff;
      font/woff2 woff2;
      font/ttf ttf;
      font/otf otf;
    }

    # Activar gzip para assets
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/css application/javascript image/svg+xml;

    # Logs activados temporalmente para debugging
    access_log /var/log/nginx/assets_access.log combined;
    error_log /var/log/nginx/assets_error.log debug;
  }

  # Archivos estáticos del public/ (favicon, logos)
  location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    try_files $uri =404;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000";
    access_log off;
  }
  # SPA routing - cualquier ruta que no sea archivo físico → index.html
  location / {
    try_files $uri $uri/ /index.html;

    # NO cachear el HTML principal para asegurar que siempre se sirve la última versión
    add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
    add_header Pragma "no-cache";
    add_header Expires "0";
    add_header Last-Modified $date_gmt;
    add_header ETag "";

    # Security headers
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "DENY";
    add_header X-XSS-Protection "1; mode=block";
  }

  # Fallback para módulos JS que no se encuentran (prevenir 404 en chunks lazy)
  location ~ \.(js|mjs|css)$ {
    try_files $uri /index.html;
    expires 1h;
    add_header Cache-Control "public, max-age=3600, must-revalidate";
  }

  # Health check endpoint
  location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
  }
}
